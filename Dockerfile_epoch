# 步骤1：使用一个与"纪元"大致同时代的操作系统基础镜像
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# 步骤2：以root身份安装系统级构建依赖
USER root
RUN apt-get update && apt-get install -y \
    build-essential autoconf bison patch rustc \
    libssl-dev libyaml-dev libreadline6-dev zlib1g-dev \
    libncurses5-dev libffi-dev libgdbm-dev libdb-dev uuid-dev \
    curl git sudo dirmngr gawk \
    pkg-config libmagic-dev \
    tzdata \
    libsqlite3-dev \
    libre2-dev \
    libkrb5-dev \
    libpq-dev \
    cmake \
    libicu-dev

# 步骤3：创建非root用户
RUN useradd --create-home --shell /bin/bash gitlab && \
    adduser gitlab sudo
USER gitlab
WORKDIR /home/gitlab

# 步骤4：安装 ASDF 
RUN git clone https://github.com/asdf-vm/asdf.git $HOME/.asdf --branch v0.10.2
# 修复：'bash -l' (非交互式登录 shell) 读取 .profile, 而不是 .bashrc。
# 我们将 asdf init 脚本写入 .profile，以便后续 'bash -l -c' 步骤可以找到它。
RUN echo -e "\n. $HOME/.asdf/asdf.sh" >> $HOME/.profile && \
    echo -e "\n. $HOME/.asdf/completions/asdf.bash" >> $HOME/.profile

# 步骤5：添加插件
# 修复：使用 'bash -l -c' 来加载 .profile 并找到 'asdf' 命令
RUN /bin/bash -l -c 'asdf plugin add ruby https://github.com/asdf-vm/asdf-ruby.git && \
    asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git && \
    asdf plugin add yarn'

# 步骤6：利用Docker缓存。先只复制版本定义文件
COPY --chown=gitlab:gitlab .tool-versions .

# 步骤7：安装精确的运行时
# 修复：使用 'bash -l -c' 来加载 .profile 并找到 'asdf'
RUN /bin/bash -l -c 'asdf install && asdf reshim'

# 步骤8：修改.dockerignore以包含vendor目录，然后复制代码
COPY --chown=gitlab:gitlab . .

# 步骤9：验证vendor目录是否存在
# RUN echo "=== Checking vendor directory ===" && \
#     ls -la vendor/ && \
#     echo "=== Checking mail-smtp_pool ===" && \
#     ls -la vendor/gems/mail-smtp_pool/

# 步骤10：安装应用依赖
# RUN /bin/bash -c 'source $HOME/.asdf/asdf.sh && \
#     gem install bundler:2.3.6 && \
#     bundle install && \
#     yarn install --frozen-lockfile'

# 修复：'bash -l' 现在将加载 .profile, 找到 asdf shims, 并定位 'gem'
# 我们不再需要显式 'source'，因为 'bash -l' 会为我们处理。
RUN /bin/bash -l -c 'gem install bundler:2.3.6 && \
    bundle install && \
    yarn install --frozen-lockfile'

# 步骤11：运行特定于应用的前端构建命令
# RUN /bin/bash -c 'source $HOME/.asdf/asdf.sh && \
#     yarn run webpack-prod'

# 修复：'bash -l' 也会加载 .profile 并找到 'yarn'
RUN /bin/bash -l -c 'yarn run webpack-prod'