# 步骤1：使用一个与"纪元"大致同时代的操作系统基础镜像
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# 步骤2：以root身份安装系统级构建依赖
USER root
RUN apt-get update && apt-get install -y \
    build-essential autoconf bison patch rustc \
    libssl-dev libyaml-dev libreadline6-dev zlib1g-dev \
    libncurses5-dev libffi-dev libgdbm-dev libdb-dev uuid-dev \
    curl git sudo dirmngr gawk \
    pkg-config libmagic-dev \
    tzdata \
    libsqlite3-dev \
    libre2-dev \
    libkrb5-dev \
    libpq-dev \
    cmake \
    libicu-dev

# 步骤3：创建非root用户
RUN useradd --create-home --shell /bin/bash gitlab && \
    adduser gitlab sudo
USER gitlab
WORKDIR /home/gitlab

# 步骤4-11：在单个RUN命令中完成所有ASDF和依赖安装
RUN set -x && \
    # 安装 ASDF
    git clone https://github.com/asdf-vm/asdf.git $HOME/.asdf --branch v0.10.2 && \
    echo -e "\n. $HOME/.asdf/asdf.sh" >> ~/.bashrc && \
    echo -e "\n. $HOME/.asdf/completions/asdf.bash" >> ~/.bashrc && \
    # 设置环境变量
    export PATH="$HOME/.asdf/shims:$HOME/.asdf/bin:$PATH" && \
    # Source asdf.sh
    . $HOME/.asdf/asdf.sh && \
    # 添加插件
    asdf plugin add ruby https://github.com/asdf-vm/asdf-ruby.git && \
    asdf plugin add nodejs https://github.com/asdf-vm/asdf-nodejs.git && \
    asdf plugin add yarn && \
    # 复制版本文件（在同一RUN步骤中）
    if [ -f .tool-versions ]; then cat .tool-versions; else echo "Using manually created .tool-versions"; fi && \
    # 安装运行时
    asdf install && \
    asdf reshim && \
    # 验证安装
    echo "=== Ruby version ===" && \
    ruby --version && \
    echo "=== Node version ===" && \
    node --version && \
    echo "=== Yarn version ===" && \
    yarn --version && \
    # 安装 bundler
    gem install bundler:2.3.6 && \
    # 验证 gem 和 bundle 可用
    echo "=== Gem list ===" && \
    gem list && \
    echo "=== Bundle version ===" && \
    bundle version