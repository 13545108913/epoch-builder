name: Build Epoch Images

on:
  push:
    branches: [ main ] # 或其他触发条件

jobs:
  build-epochs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 确保一个版本失败不会取消其他版本的构建
      matrix:
        # 定义所有纪元目标
        epoch_version: ["v13.12.15", "v14.10.5", "v15.4.6", "v16.3.9"]

    steps:
      - name: 登录到 Docker 镜像仓库
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 检出构建器仓库 (Checkout Builder Repo)
        uses: actions/checkout@v4

      - name: 检出目标版本的 GitLab 代码
        uses: actions/checkout@v4
        with:
          repository: gitlabhq/gitlabhq # 或 EE 仓库
          ref: ${{ matrix.epoch_version }} # 检出矩阵中定义的特定 git 标签
          path: gitlab-src # **重要：** 检出到子目录 'gitlab-src'
          
      # --- 关键修正步骤：确保 .tool-versions 文件存在 ---
      - name: 确保 .tool-versions 文件存在
        # 为没有 .tool-versions 文件的旧版本 "纪元" 手动创建该文件
        # 这是解决 "构建腐烂" 的关键一步
        # (v14.10.5 使用 Ruby 2.7.5, Node 14.19.3)
        # (v13.12.15 使用 Ruby 2.7.2, Node 12.22.1)
        run: |
          cd gitlab-src
          if [ ! -f .tool-versions ]; then
            echo "File .tool-versions not found. Creating one based on matrix version."
            if [ "${{ matrix.epoch_version }}" = "v14.10.5" ]; then
              echo "ruby 2.7.5" > .tool-versions
              echo "nodejs 14.19.3" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            elif [ "${{ matrix.epoch_version }}" = "v13.12.15" ]; then
              echo "ruby 2.7.2" > .tool-versions
              echo "nodejs 12.22.1" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            # --- ⬇️ 您需要添加类似这样的块 ⬇️ ---
            # 警告：请务必核实这些版本号是否正确！
            elif [ "${{ matrix.epoch_version }}" = "v15.4.6" ]; then
              echo "ruby 3.0.4" > .tool-versions
              echo "nodejs 16.19.1" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            
            # 警告：请务必核实这些版本号是否正确！
            elif [ "${{ matrix.epoch_version }}" = "v16.3.9" ]; then
              echo "ruby 3.0.6" > .tool-versions
              echo "nodejs 18.19.0" > .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            # --- ⬆️ 添加结束 ⬆️ ---
            else
              # 如果矩阵中添加了其他没有 .tool-versions 的版本，则构建将在此处失败
              echo "ERROR: No .tool-versions file found and no manual override for ${{ matrix.epoch_version }}"
              exit 1
            fi
            echo "Created .tool-versions:"
            cat .tool-versions
          else
            echo ".tool-versions file already exists, ensuring yarn 1.22.19 is included..."
            # 如果文件已存在，确保包含 yarn 1.22.19
            if ! grep -q "yarn" .tool-versions; then
              echo "yarn 1.22.19" >> .tool-versions
              echo "Added yarn 1.22.19 to existing .tool-versions"
            else
              # 如果已有 yarn，确保版本正确
              sed -i 's/^yarn .*/yarn 1.22.19/' .tool-versions
              echo "Updated yarn version to 1.22.19 in existing .tool-versions"
            fi
            echo "Final .tool-versions:"
            cat .tool-versions
          fi
        shell: bash
      
      # --- 新增步骤：在构建前删除 .dockerignore ---
      - name: 强制删除 .dockerignore (确保 vendor 等目录被复制)
        run: |
          DOCKERIGNORE_PATH="gitlab-src/.dockerignore"
          if [ -f "$DOCKERIGNORE_PATH" ]; then
            echo "Found .dockerignore at $DOCKERIGNORE_PATH. Removing it to ensure all files (like vendor/) are copied into the Docker build."
            rm -f "$DOCKERIGNORE_PATH"
          else
            echo "No .dockerignore file found in gitlab-src, proceeding."
          fi
        shell: bash

      # --- 构建步骤（现在是安全的） ---
      - name: 构建并推送纪元镜像
        uses: docker/build-push-action@v6
        with:
          # context 指向 GitLab 源代码，Dockerfile 中的 COPY 指令将在这里查找文件
          context: ./gitlab-src 
          # file 指向我们仓库根目录下的 Dockerfile
          file: ./Dockerfile_epoch 
          push: true
          tags: chenboyu12138/gitlab:${{ matrix.epoch_version }}