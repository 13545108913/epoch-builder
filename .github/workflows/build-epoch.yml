name: Build Epoch Images

on:
  push:
    branches: [ main ]

jobs:
  build-epochs:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        epoch_version: ["v13.12.15", "v14.10.5", "v15.4.6", "v16.3.9"]

    steps:
      - name: 登录到 Docker 镜像仓库
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 步骤 1: 设置 QEMU 以支持多架构构建 ---
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # --- 步骤 2: 设置 Docker Buildx (需要明确指定平台) ---
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: 检出构建器仓库
        uses: actions/checkout@v4

      - name: 检出目标版本的 GitLab 代码
        uses: actions/checkout@v4
        with:
          repository: gitlabhq/gitlabhq
          ref: ${{ matrix.epoch_version }}
          path: gitlab-src
          
      # --- 关键修正步骤：确保 .tool-versions 文件存在 ---
      - name: 确保 .tool-versions 文件存在
        # 为没有 .tool-versions 文件的旧版本 "纪元" 手动创建该文件
        # 这是解决 "构建腐烂" 的关键一步
        # (v14.10.5 使用 Ruby 2.7.5, Node 14.19.3)
        # (v13.12.15 使用 Ruby 2.7.2, Node 12.22.1)
        run: |
          cd gitlab-src
          if [ ! -f .tool-versions ]; then
            echo "File .tool-versions not found. Creating one based on matrix version."
            if [ "${{ matrix.epoch_version }}" = "v14.10.5" ]; then
              echo "ruby 2.7.5" > .tool-versions
              echo "nodejs 14.19.3" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            elif [ "${{ matrix.epoch_version }}" = "v13.12.15" ]; then
              echo "ruby 2.7.2" > .tool-versions
              echo "nodejs 12.22.1" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            # --- ⬇️ 您需要添加类似这样的块 ⬇️ ---
            # 警告：请务必核实这些版本号是否正确！
            elif [ "${{ matrix.epoch_version }}" = "v15.4.6" ]; then
              echo "ruby 3.0.4" > .tool-versions
              echo "nodejs 16.19.1" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            
            # 警告：请务必核实这些版本号是否正确！
            elif [ "${{ matrix.epoch_version }}" = "v16.3.9" ]; then
              echo "ruby 3.0.6" > .tool-versions
              echo "nodejs 18.19.0" >> .tool-versions
              echo "yarn 1.22.19" >> .tool-versions
            # --- ⬆️ 添加结束 ⬆️ ---
            else
              # 如果矩阵中添加了其他没有 .tool-versions 的版本，则构建将在此处失败
              echo "ERROR: No .tool-versions file found and no manual override for ${{ matrix.epoch_version }}"
              exit 1
            fi
            echo "Created .tool-versions:"
            cat .tool-versions
          else
            echo ".tool-versions file already exists, ensuring yarn 1.22.19 is included..."
            # 如果文件已存在，确保包含 yarn 1.22.19
            if ! grep -q "yarn" .tool-versions; then
              echo "yarn 1.22.19" >> .tool-versions
              echo "Added yarn 1.22.19 to existing .tool-versions"
            else
              # 如果已有 yarn，确保版本正确
              sed -i 's/^yarn .*/yarn 1.22.19/' .tool-versions
              echo "Updated yarn version to 1.22.19 in existing .tool-versions"
            fi
            echo "Final .tool-versions:"
            cat .tool-versions
          fi
        shell: bash
      
      # --- 修改步骤：在构建前从 .dockerignore 中删除特定条目 ---
      - name: 修改 .dockerignore (确保关键目录被复制)
        run: |
          DOCKERIGNORE_PATH="gitlab-src/.dockerignore"
          if [ -f "$DOCKERIGNORE_PATH" ]; then
            echo "Found .dockerignore. Removing specific entries to ensure they are copied into the Docker build."
            # 删除 vendor, app, config, public, bin 及其子目录的忽略规则
            # 使用 sed 匹配以可选 '/' 开头，后跟目录名，再接可选 '/' 或 '/.*' 的行
            sed -i -E '\#^/?(vendor|app|config|public|bin|scripts|fixtures|spec)($|/.*)#d' "$DOCKERIGNORE_PATH"
            # 删除 package.json 和 yarn.lock 的忽略规则
            sed -i -E '\#^/?(package\.json|yarn\.lock)$#d' "$DOCKERIGNORE_PATH"
            
            echo "Updated .dockerignore:"
            cat "$DOCKERIGNORE_PATH"
          else
            echo "No .dockerignore file found in gitlab-src, proceeding."
          fi
        shell: bash

      # --- 构建步骤（支持多架构） ---
      - name: 构建并推送纪元镜像
        uses: docker/build-push-action@v6
        with:
          context: ./gitlab-src
          file: ./Dockerfile_epoch
          platforms: linux/amd64,linux/arm64
          push: true
          tags: chenboyu12138/gitlab:${{ matrix.epoch_version }}
          # 可选：添加构建缓存以提高性能
          cache-from: type=gha
          cache-to: type=gha,mode=max